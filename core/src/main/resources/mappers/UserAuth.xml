<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.madhouse.platform.premiummad.dao.UserAuthDao">
    
    <sql id="baseMediaColumns">
		${alias}.id, ${alias}.user_id, ${alias}.media_id, ${alias}.status, ${alias}.created_user, 
		${alias}.updated_user, ${alias}.created_time, ${alias}.updated_time
	</sql>
	
	<select id="checkAdminForMedia" parameterType="integer" resultType="integer">
		SELECT count(0) FROM mad_sys_user_media WHERE user_id = #{userId} AND media_id = -1
	</select>
	
	<select id="checkAdminForPolicy" parameterType="integer" resultType="integer">
		SELECT count(0) FROM mad_sys_user_policy WHERE user_id = #{userId} AND policy_id = -1
	</select>
	
	<select id="queryMediaIdList" parameterType="string" resultType="integer">
		SELECT * FROM (
			SELECT um.media_id mediaId
	        FROM mad_sys_user_media um
	        <if test="isAdmin != 1">WHERE um.user_id = #{userId}</if>
	        UNION 
	        SELECT m.id mediaId
	        FROM mad_sys_media m
	        <if test="isAdmin != 1">WHERE m.created_user = #{userId}</if>
        ) t <if test="mediaIds != null and mediaIds.length > 0">
        	WHERE t.mediaId IN 
        	<foreach collection="mediaIds" item="mediaId" index="index" open="(" close=")" separator=",">
            	#{mediaId,jdbcType=INTEGER}
            </foreach>
        </if>
	</select>
	
	<select id="queryAdspaceIdList" parameterType="string" resultType="integer">
		SELECT * FROM (
			SELECT a.id adspaceId
			FROM mad_sys_adspace a
			<if test="isAdmin != 1">
		        LEFT JOIN mad_sys_user_media um ON a.media_id = um.media_id
		        LEFT JOIN mad_sys_media m ON a.media_id = m.id
		        WHERE um.user_id = #{userId} OR (m.created_user = #{userId} OR a.created_user = #{userId})
			</if>
        ) t <if test="adspaceIds != null and adspaceIds.length > 0">
        	WHERE t.adspaceId IN 
        	<foreach collection="adspaceIds" item="adspaceId" index="index" open="(" close=")" separator=",">
            	#{adspaceId,jdbcType=INTEGER}
            </foreach>
        </if>
	</select>
	
	<select id="queryPolicyIdList" parameterType="string" resultType="integer">
		SELECT * FROM (
			SELECT up.policy_id policyId
	        FROM mad_sys_user_policy up
	        <if test="isAdmin != 1">WHERE up.user_id = #{userId}</if>
	        UNION 
	        SELECT p.id policyId
	        FROM mad_sys_policy p
	        <if test="isAdmin != 1">WHERE p.created_user = #{userId}</if>
        ) t <if test="policyIds != null and policyIds.length > 0">
        	WHERE t.policyId IN 
        	<foreach collection="policyIds" item="policyId" index="index" open="(" close=")" separator=",">
            	#{policyId,jdbcType=INTEGER}
            </foreach>
        </if>
	</select>
	
	<delete id="removeUserMediaAuth" parameterType="integer">
		DELETE FROM mad_sys_user_media
		WHERE user_id = #{userId}
	</delete>
	
	<update id="updateUserMediaAuth" parameterType="com.madhouse.platform.premiummad.entity.Adspace">
        UPDATE mad_sys_adspace
        <set>
            <if test="status != null">status = #{status},</if>
            <if test="updatedUser != null">updated_user = #{updatedUser},</if>
            <if test="updatedTime != null">updated_time = #{updatedTime},</if>
        </set>
        WHERE id = #{id}
    </update>
    
    <insert id="insertAdspaceDspMapping" parameterType="java.util.List">
   		<selectKey resultType ="java.lang.Long" keyProperty= "id" order= "AFTER">  
	        SELECT LAST_INSERT_ID()  
	    </selectKey>  
           	INSERT INTO mad_sys_adspace_mapping_dsp (adspace_id, dsp_id, dsp_media_id, 
          		dsp_adspace_key,created_time, status) VALUES
	          		<foreach collection="dspMappings" index="index" item="dspMapping" separator=",">
	          			<if test="(dspMapping.dspMediaId != null and dspMapping.dspMediaId.trim() != '')
	          			 or (dspMapping.dspAdspaceKey != null and dspMapping.dspAdspaceKey.trim() != '')">
		          			(
		          				#{dspMapping.adspaceId},
		          				#{dspMapping.dspId},
		          				#{dspMapping.dspMediaId},
		          				#{dspMapping.dspAdspaceKey},
		          				#{dspMapping.createdTime},
		          				1
		          			)
	          			 </if>
	        		</foreach>
    </insert>
</mapper>